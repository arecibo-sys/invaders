<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>SPACE INVADERS — ACID MOBILE</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      background: #000;
      overflow: hidden;
      touch-action: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    #canvasWrap {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    #gameCanvas {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      box-shadow: 0 0 30px #00FF41, 0 0 60px #003300;
      display: block;
    }

    #overlay {
      position: absolute;
      top: 0; left: 0;
      pointer-events: none;
    }

    /* ── CONTROL PANEL ── */
    #controls {
      width: 100%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      background: #000;
      border-top: 1px solid #003300;
      gap: 8px;
    }

    .ctrl-group {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: #0a1a0a;
      border: 2px solid #00AA22;
      border-radius: 50%;
      color: #00FF41;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.05s, border-color 0.05s;
      position: relative;
      box-shadow: 0 0 8px #003300, inset 0 0 6px #001100;
      flex-shrink: 0;
    }

    .btn:active, .btn.pressed {
      background: #003300;
      border-color: #00FF41;
      box-shadow: 0 0 16px #00FF41, inset 0 0 10px #002200;
    }

    .btn-fire {
      background: #1a0000;
      border-color: #AA2200;
      color: #FF4400;
      box-shadow: 0 0 8px #330000, inset 0 0 6px #110000;
    }

    .btn-fire:active, .btn-fire.pressed {
      background: #330000;
      border-color: #FF4400;
      box-shadow: 0 0 16px #FF4400, inset 0 0 10px #220000;
    }

    .btn-pause {
      background: #0a0a1a;
      border-color: #2244AA;
      color: #4488FF;
      font-size: 14px;
      box-shadow: 0 0 6px #001133, inset 0 0 4px #000a22;
    }

    .btn-pause:active, .btn-pause.pressed {
      background: #001133;
      border-color: #4488FF;
    }

    /* label under fire button */
    .btn-label {
      position: absolute;
      bottom: -16px;
      font-size: 9px;
      letter-spacing: 1px;
      color: #003300;
      font-family: monospace;
      white-space: nowrap;
    }

    /* ── MUSIC TOGGLE ── */
    #musicBtn {
      font-size: 11px;
      letter-spacing: 1px;
      font-family: monospace;
      padding: 0 10px;
      border-radius: 12px;
    }
  </style>
</head>
<body>

<div id="canvasWrap">
  <canvas id="gameCanvas"></canvas>
  <canvas id="overlay"></canvas>
</div>

<div id="controls">
  <!-- LEFT -->
  <div class="ctrl-group">
    <div class="btn" id="btnLeft">◄</div>
  </div>

  <!-- CENTER: FIRE + PAUSE -->
  <div class="ctrl-group" style="flex-direction:column; align-items:center; gap:6px; position:relative; padding-bottom:18px;">
    <div class="btn btn-fire" id="btnFire" style="position:relative;">
      ●
      <span class="btn-label">FIRE</span>
    </div>
    <div class="btn btn-pause" id="btnPause">II</div>
  </div>

  <!-- RIGHT -->
  <div class="ctrl-group">
    <div class="btn" id="btnRight">►</div>
  </div>
</div>

<script>
// ============================================================
// SPACE INVADERS — ACID MOBILE EDITION
// ============================================================

const W = 224, H = 256;
let SCALE = 1;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const octx = overlay.getContext('2d');
const canvasWrap = document.getElementById('canvasWrap');
const controlsEl = document.getElementById('controls');

function resize() {
  const screenW = window.innerWidth;
  const screenH = window.innerHeight;
  // Reserve space for controls
  const ctrlH = Math.max(110, Math.floor(screenH * 0.2));
  controlsEl.style.height = ctrlH + 'px';

  // Button sizes proportional to control height
  const btnSize = Math.floor(ctrlH * 0.42);
  document.querySelectorAll('.btn').forEach(b => {
    b.style.width = btnSize + 'px';
    b.style.height = btnSize + 'px';
  });

  const availH = screenH - ctrlH;
  SCALE = Math.min(screenW / W, availH / H);
  SCALE = Math.max(1, SCALE); // never below 1x

  const cw = Math.floor(W * SCALE);
  const ch = Math.floor(H * SCALE);

  canvas.width = cw; canvas.height = ch;
  overlay.width = cw; overlay.height = ch;
  overlay.style.width = cw + 'px'; overlay.style.height = ch + 'px';
  canvas.style.width = cw + 'px'; canvas.style.height = ch + 'px';

  canvasWrap.style.width = cw + 'px';
  canvasWrap.style.height = ch + 'px';

  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(SCALE, SCALE);
}

window.addEventListener('resize', resize);
resize();

// ============================================================
// AUDIO
// ============================================================
let audioCtx = null;
let musicEnabled = true;
let sfxGain, musicGain, drumGain;
let acidOsc, acidFilter, acidVCA;
let padOsc1, padOsc2, padOsc3, padFilter, padGain;
let nextNoteTime = 0, currentBeat = 0;
let musicIntensity = 0, targetIntensity = 0, bpm = 128;
let ufoOsc = null, ufoOscLFO = null, ufoGain = null;

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.7; sfxGain.connect(audioCtx.destination);
  musicGain = audioCtx.createGain(); musicGain.gain.value = musicEnabled ? 0.45 : 0; musicGain.connect(audioCtx.destination);
  initMusicEngine();
}

function sfxShoot() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
  osc.type='sawtooth'; osc.frequency.setValueAtTime(800,audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(200,audioCtx.currentTime+0.12);
  g.gain.setValueAtTime(0.3,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.12);
  osc.connect(g); g.connect(sfxGain); osc.start(); osc.stop(audioCtx.currentTime+0.13);
}

function sfxAlienDie() {
  if (!audioCtx) return;
  const sz=Math.floor(audioCtx.sampleRate*0.2); const buf=audioCtx.createBuffer(1,sz,audioCtx.sampleRate);
  const d=buf.getChannelData(0); for(let i=0;i<sz;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/sz,2);
  const src=audioCtx.createBufferSource(); const f=audioCtx.createBiquadFilter(); const g=audioCtx.createGain();
  f.type='bandpass'; f.frequency.value=600; f.Q.value=0.8;
  g.gain.setValueAtTime(0.5,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);
  src.buffer=buf; src.connect(f); f.connect(g); g.connect(sfxGain); src.start();
}

function sfxPlayerDie() {
  if (!audioCtx) return;
  const t=audioCtx.currentTime;
  const o1=audioCtx.createOscillator(); const g1=audioCtx.createGain();
  o1.type='sawtooth'; o1.frequency.value=600; g1.gain.setValueAtTime(0.4,t); g1.gain.exponentialRampToValueAtTime(0.001,t+0.15);
  o1.connect(g1); g1.connect(sfxGain); o1.start(t); o1.stop(t+0.15);
  const sz=Math.floor(audioCtx.sampleRate*0.2); const buf=audioCtx.createBuffer(1,sz,audioCtx.sampleRate);
  const d=buf.getChannelData(0); for(let i=0;i<sz;i++) d[i]=(Math.random()*2-1)*(1-i/sz);
  const src=audioCtx.createBufferSource(); const g2=audioCtx.createGain();
  src.buffer=buf; g2.gain.setValueAtTime(0.5,t+0.15); src.connect(g2); g2.connect(sfxGain); src.start(t+0.15);
  const o3=audioCtx.createOscillator(); const g3=audioCtx.createGain();
  o3.type='triangle'; o3.frequency.value=200; g3.gain.setValueAtTime(0.4,t+0.35); g3.gain.exponentialRampToValueAtTime(0.001,t+0.65);
  o3.connect(g3); g3.connect(sfxGain); o3.start(t+0.35); o3.stop(t+0.65);
}

function sfxUFOStart() {
  if (!audioCtx || ufoOsc) return;
  ufoOsc = audioCtx.createOscillator();
  ufoOscLFO = audioCtx.createOscillator();
  const osc2 = audioCtx.createOscillator();
  ufoGain = audioCtx.createGain();
  const lp = audioCtx.createBiquadFilter();
  ufoOsc.type='sine'; ufoOsc.frequency.value=320;
  osc2.type='sine'; osc2.frequency.value=325;
  ufoOscLFO.type='sine'; ufoOscLFO.frequency.value=2.5;
  lp.type='lowpass'; lp.frequency.value=900; lp.Q.value=0.5;
  ufoGain.gain.value=0;
  ufoOsc.connect(lp); osc2.connect(lp); lp.connect(ufoGain); ufoGain.connect(sfxGain);
  ufoOsc.start(); osc2.start(); ufoOscLFO.start();
  ufoGain.gain.setValueAtTime(0,audioCtx.currentTime);
  ufoGain.gain.linearRampToValueAtTime(0.06,audioCtx.currentTime+0.4);
  ufoOsc._osc2 = osc2;
}

function sfxUFOStop() {
  if (ufoOsc) { try{if(ufoOsc._osc2) ufoOsc._osc2.stop();}catch(e){} try{ufoOsc.stop();}catch(e){} ufoOsc=null; }
  if (ufoOscLFO) { try{ufoOscLFO.stop();}catch(e){} ufoOscLFO=null; }
}

function sfxUFOHit() {
  sfxUFOStop(); if (!audioCtx) return;
  const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
  osc.type='sawtooth'; osc.frequency.setValueAtTime(1200,audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100,audioCtx.currentTime+0.6);
  g.gain.setValueAtTime(0.4,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.6);
  osc.connect(g); g.connect(sfxGain); osc.start(); osc.stop(audioCtx.currentTime+0.61);
}

const MARCH_NOTES=[160,130,110,95]; let marchNoteIdx=0;
function sfxMarch() {
  if (!audioCtx) return;
  const freq=MARCH_NOTES[marchNoteIdx++%4];
  const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
  osc.type='square'; osc.frequency.value=freq;
  g.gain.setValueAtTime(0.35,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.055);
  osc.connect(g); g.connect(sfxGain); osc.start(); osc.stop(audioCtx.currentTime+0.06);
}

// ── MUSIC ──
const ACID_NOTES_HZ=[55,65.41,82.41,98,110,130.81,164.81];
const ACID_PATTERNS=[
  [0,null,null,0,null,null,null,0,null,null,0,null,0,null,null,null],
  [0,0,2,null,2,null,4,null,0,null,2,null,4,null,0,0],
  [0,0,2,2,4,null,2,0,0,2,4,null,2,2,0,0],
  [0,2,0,2,4,2,4,2,0,2,0,4,2,0,2,4],
  [0,0,2,0,4,0,2,0,0,4,2,0,4,0,2,0],
];
const PAD_CHORDS=[[55,65.41,82.41],[43.65,55,65.41],[32.7,41.2,49],[49,61.74,73.42]];

function getAcidPattern() {
  if(musicIntensity<0.2) return ACID_PATTERNS[0]; if(musicIntensity<0.4) return ACID_PATTERNS[1];
  if(musicIntensity<0.6) return ACID_PATTERNS[2]; if(musicIntensity<0.8) return ACID_PATTERNS[3];
  return ACID_PATTERNS[4];
}

function initMusicEngine() {
  drumGain=audioCtx.createGain(); drumGain.gain.value=0.8; drumGain.connect(musicGain);
  acidOsc=audioCtx.createOscillator(); acidFilter=audioCtx.createBiquadFilter(); acidVCA=audioCtx.createGain();
  acidOsc.type='sawtooth'; acidOsc.frequency.value=55;
  acidFilter.type='lowpass'; acidFilter.frequency.value=400; acidFilter.Q.value=12;
  acidVCA.gain.value=0; acidOsc.connect(acidFilter); acidFilter.connect(acidVCA); acidVCA.connect(musicGain); acidOsc.start();
  padOsc1=audioCtx.createOscillator(); padOsc2=audioCtx.createOscillator(); padOsc3=audioCtx.createOscillator();
  padFilter=audioCtx.createBiquadFilter(); padGain=audioCtx.createGain();
  [padOsc1,padOsc2,padOsc3].forEach(o=>{o.type='sawtooth';o.frequency.value=55;o.start();});
  padOsc2.frequency.value=55.165; padOsc3.frequency.value=54.835;
  padFilter.type='lowpass'; padFilter.frequency.value=800; padFilter.Q.value=2;
  padGain.gain.value=0.04;
  [padOsc1,padOsc2,padOsc3].forEach(o=>o.connect(padFilter)); padFilter.connect(padGain); padGain.connect(musicGain);
  nextNoteTime=audioCtx.currentTime+0.1; scheduleMusicBeats();
}

function scheduleMusicBeats() {
  const ahead=0.15;
  while(nextNoteTime<audioCtx.currentTime+ahead) {
    const b16=currentBeat%16; const t=nextNoteTime;
    musicIntensity+=(targetIntensity-musicIntensity)*0.015;
    bpm=128+Math.floor(musicIntensity*17); const spb=60/bpm/4;
    if(musicIntensity>0.15){
      const kp=musicIntensity<0.6?[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0]:[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0];
      if(kp[b16]) scheduleKick(t);
    }
    if(musicIntensity>0.2&&(b16===4||b16===12)) scheduleSnare(t);
    if(musicIntensity>0.1&&b16%2===0) scheduleHihat(t,false);
    if(musicIntensity>0.7&&b16%4===3) scheduleHihat(t,true);
    if(musicIntensity>0.15){
      const pat=getAcidPattern(); const note=pat[b16];
      if(note!==null&&note!==undefined){
        const acc=(b16===0||b16===8)&&musicIntensity>0.5;
        scheduleAcidNote(t,ACID_NOTES_HZ[note],acc,spb*0.88);
      }
    }
    if(b16===0){
      const ci=Math.floor(currentBeat/16)%4; const ch=PAD_CHORDS[ci];
      const v=0.03+musicIntensity*0.1; padGain.gain.setTargetAtTime(v,t,0.5);
      padOsc1.frequency.setTargetAtTime(ch[0],t,0.4); padOsc2.frequency.setTargetAtTime(ch[0]*1.003,t,0.4); padOsc3.frequency.setTargetAtTime(ch[0]*0.997,t,0.4);
    }
    currentBeat++; nextNoteTime+=spb;
  }
  setTimeout(scheduleMusicBeats,80);
}

function scheduleKick(t){
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(40,t+0.05);
  g.gain.setValueAtTime(1.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.5);
  o.connect(g); g.connect(drumGain); o.start(t); o.stop(t+0.51);
}

function scheduleSnare(t){
  const sz=Math.floor(audioCtx.sampleRate*0.15); const buf=audioCtx.createBuffer(1,sz,audioCtx.sampleRate);
  const d=buf.getChannelData(0); for(let i=0;i<sz;i++) d[i]=(Math.random()*2-1)*(1-i/sz);
  const src=audioCtx.createBufferSource(); const bp=audioCtx.createBiquadFilter(); const gn=audioCtx.createGain();
  bp.type='bandpass'; bp.frequency.value=2000; bp.Q.value=0.5;
  src.buffer=buf; gn.gain.setValueAtTime(0.8,t); gn.gain.exponentialRampToValueAtTime(0.001,t+0.15);
  src.connect(bp); bp.connect(gn); gn.connect(drumGain); src.start(t);
  const tone=audioCtx.createOscillator(); const tg=audioCtx.createGain();
  tone.type='triangle'; tone.frequency.value=200; tg.gain.setValueAtTime(0.5,t); tg.gain.exponentialRampToValueAtTime(0.001,t+0.08);
  tone.connect(tg); tg.connect(drumGain); tone.start(t); tone.stop(t+0.09);
}

function scheduleHihat(t,open){
  const dur=open?0.18:0.025; const sz=Math.floor(audioCtx.sampleRate*dur);
  const buf=audioCtx.createBuffer(1,sz,audioCtx.sampleRate); const d=buf.getChannelData(0);
  for(let i=0;i<sz;i++) d[i]=(Math.random()*2-1)*(1-i/sz);
  const src=audioCtx.createBufferSource(); const hp=audioCtx.createBiquadFilter(); const gn=audioCtx.createGain();
  hp.type='highpass'; hp.frequency.value=7000;
  src.buffer=buf; gn.gain.setValueAtTime(0.4,t); gn.gain.exponentialRampToValueAtTime(0.001,t+dur);
  src.connect(hp); hp.connect(gn); gn.connect(drumGain); src.start(t);
}

function scheduleAcidNote(t,freq,accent,dur){
  const prev=acidOsc.frequency.value; const glide=musicIntensity>0.5?0.04:0.01;
  acidOsc.frequency.setValueAtTime(prev,t); acidOsc.frequency.exponentialRampToValueAtTime(Math.max(20,freq),t+glide);
  const cb=300+musicIntensity*2200; const ca=accent?cb*2.5:cb;
  acidFilter.frequency.setValueAtTime(cb*0.5,t); acidFilter.frequency.setTargetAtTime(ca,t,0.008); acidFilter.frequency.exponentialRampToValueAtTime(Math.max(20,cb),t+dur*0.7);
  acidFilter.Q.setValueAtTime(accent?20:(8+musicIntensity*10),t);
  const vel=accent?0.7:0.35+musicIntensity*0.2;
  acidVCA.gain.cancelScheduledValues(t); acidVCA.gain.setValueAtTime(0.001,t); acidVCA.gain.linearRampToValueAtTime(vel,t+0.005);
  acidVCA.gain.exponentialRampToValueAtTime(vel*0.3,t+dur*0.5); acidVCA.gain.exponentialRampToValueAtTime(0.001,t+dur);
}

// ============================================================
// SPRITES
// ============================================================
const SPRITES={
  squid_a:['..XXXX..', '.XXXXXX.','XXXXXXXX','XX.XX.XX','XXXXXXXX','..X..X..', '.X.XX.X.','X......X'],
  squid_b:['.XXXXXX.','XX.XX.XX','XXXXXXXX','.X.XX.X.','XXXXXXXX','..X..X..', '.X.XX.X.','X......X'],
  crab_a: ['..X.....X..','...X...X...','..XXXXXXX..','.XX.XXX.XX.','XXXXXXXXXXX','X.XXXXXXX.X','X.X.....X.X','...XX.XX...'],
  crab_b: ['..X.....X..','X..X...X..X','X.XXXXXXX.X','XXX.XXX.XXX','.XXXXXXXXX.','..XXXXXXX..','...X...X...','..X.....X..'],
  octopus_a:['...XXXXXX...','.XXXXXXXXXX.','XXXXXXXXXXXX','XX.XXXXXX.XX','XXXXXXXXXXXX','...XX..XX...','..XX.XX.XX..', '.XX......XX.'],
  octopus_b:['...XXXXXX...','.XXXXXXXXXX.','XXXXXXXXXXXX','XX.XXXXXX.XX','XXXXXXXXXXXX','.XX......XX.','X.X.XXXX.X.X','..XX....XX..'],
  player:    ['.....X.....','....XXX....','.XXXXXXXXX.','XXXXXXXXXXX','XXXXXXXXXXX'],
  ufo:       ['...XXXXXXX...','.XXXXXXXXXXX.','XXXXXXXXXXXXX','XX.XXX.X.XXX.','XXXXXXXXXXXXX','.XX.XX.XX.XX.','..X.....X....'],
  explosion: ['X..X..X','.X.X.X.','..XXX..','XXXXXXX','..XXX..','.X.X.X.','X..X..X'],
};

function drawSprite(context,sprite,x,y,color){
  context.fillStyle=color;
  sprite.forEach((row,ry)=>{
    for(let rx=0;rx<row.length;rx++) if(row[rx]==='X') context.fillRect(Math.floor(x)+rx,Math.floor(y)+ry,1,1);
  });
}

// ============================================================
// PIXEL FONT
// ============================================================
const FONT={
  '0':['01110','10001','10011','10101','11001','10001','01110'],'1':['00100','01100','00100','00100','00100','00100','01110'],
  '2':['01110','10001','00001','00110','01000','10000','11111'],'3':['11110','00001','00001','01110','00001','00001','11110'],
  '4':['00010','00110','01010','10010','11111','00010','00010'],'5':['11111','10000','10000','11110','00001','00001','11110'],
  '6':['01110','10000','10000','11110','10001','10001','01110'],'7':['11111','00001','00010','00100','01000','01000','01000'],
  '8':['01110','10001','10001','01110','10001','10001','01110'],'9':['01110','10001','10001','01111','00001','10001','01110'],
  'A':['01110','10001','10001','11111','10001','10001','10001'],'B':['11110','10001','10001','11110','10001','10001','11110'],
  'C':['01110','10001','10000','10000','10000','10001','01110'],'D':['11110','10001','10001','10001','10001','10001','11110'],
  'E':['11111','10000','10000','11110','10000','10000','11111'],'F':['11111','10000','10000','11110','10000','10000','10000'],
  'G':['01110','10001','10000','10111','10001','10001','01110'],'H':['10001','10001','10001','11111','10001','10001','10001'],
  'I':['01110','00100','00100','00100','00100','00100','01110'],'L':['10000','10000','10000','10000','10000','10000','11111'],
  'M':['10001','11011','10101','10001','10001','10001','10001'],'N':['10001','11001','10101','10011','10001','10001','10001'],
  'O':['01110','10001','10001','10001','10001','10001','01110'],'P':['11110','10001','10001','11110','10000','10000','10000'],
  'R':['11110','10001','10001','11110','10100','10010','10001'],'S':['01110','10001','10000','01110','00001','10001','01110'],
  'T':['11111','00100','00100','00100','00100','00100','00100'],'U':['10001','10001','10001','10001','10001','10001','01110'],
  'V':['10001','10001','10001','10001','10001','01010','00100'],'W':['10001','10001','10001','10101','10101','11011','10001'],
  'X':['10001','10001','01010','00100','01010','10001','10001'],'Y':['10001','10001','01010','00100','00100','00100','00100'],
  'Z':['11111','00001','00010','00100','01000','10000','11111'],' ':['00000','00000','00000','00000','00000','00000','00000'],
  '-':['00000','00000','00000','11111','00000','00000','00000'],'!':['00100','00100','00100','00100','00100','00000','00100'],
  '.':['00000','00000','00000','00000','00000','00000','00100'],'<':['00001','00010','00100','01000','00100','00010','00001'],
  '>':['10000','01000','00100','00010','00100','01000','10000'],
};

function drawText(context,text,x,y,color,scale=1){
  context.fillStyle=color; let cx=x;
  for(const ch of text.toUpperCase()){
    const g=FONT[ch]||FONT[' '];
    g.forEach((row,ry)=>{ for(let rx=0;rx<5;rx++) if(row[rx]==='1') context.fillRect(cx+rx*scale,y+ry*scale,scale,scale); });
    cx+=(5+1)*scale;
  }
}
function textWidth(text,scale=1){return text.length*6*scale;}

// ============================================================
// GAME STATE
// ============================================================
const GS={TITLE:'TITLE',PLAYING:'PLAYING',DEAD:'DEAD',WAVE_CLEAR:'WAVE_CLEAR',GAME_OVER:'GAME_OVER',PAUSED:'PAUSED'};
let state=GS.TITLE, score=0, hiScore=0, lives=3, wave=1, frameCount=0;
let player={x:104,y:232,alive:true};
let playerBullet=null, playerDeathTimer=0, playerDeathFrame=0;
let aliens=[], alienDir=1, alienStepTimer=0, alienStepInterval=800, alienAnimFrame=0, aliensKilled=0;
let alienBullets=[], alienBulletTimer=0;
let ufo=null, ufoTimer=3000;
const UFO_POINTS=[50,100,150,300]; let ufoShotCount=0;
let shields=[];
const SHIELD_X=[26,69,112,155];
let popups=[], waveClearTimer=0;
let titleAliens=[], titleAnimTimer=0;

// Virtual keys (driven by touch)
const keys={};

// ============================================================
// SHIELDS
// ============================================================
function createShield(sx,sy){
  const t=['XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXXXXXXXXXXXXXXXXXXX','XXXXX.........XXXXXXXX','XXXX...........XXXXXXX','XXX.............XXXXXX','.......................'];
  return{x:sx,y:sy,w:22,h:15,pixels:t.map(r=>r.split('').map(c=>c==='X'?1:0))};
}
function initShields(){shields=SHIELD_X.map(x=>createShield(x,190));}
function drawShields(){
  ctx.fillStyle='#00FF41';
  shields.forEach(s=>{for(let y=0;y<s.h;y++) for(let x=0;x<s.w;x++) if(s.pixels[y]&&s.pixels[y][x]) ctx.fillRect(s.x+x,s.y+y,1,1);});
}
function damageShield(s,bx,by,r=2){
  const lx=Math.floor(bx-s.x),ly=Math.floor(by-s.y);
  for(let dy=-r;dy<=r+1;dy++) for(let dx=-r;dx<=r+1;dx++){const px=lx+dx,py=ly+dy;if(py>=0&&py<s.h&&px>=0&&px<s.w&&s.pixels[py])s.pixels[py][px]=0;}
}
function bulletHitsShield(bx,by){
  for(const s of shields) if(bx>=s.x&&bx<s.x+s.w&&by>=s.y&&by<s.y+s.h){const lx=Math.floor(bx-s.x),ly=Math.floor(by-s.y);if(s.pixels[ly]&&s.pixels[ly][lx]){damageShield(s,bx,by,2);return true;}}
  return false;
}

// ============================================================
// INIT
// ============================================================
function initAliens(){
  aliens=[]; aliensKilled=0; alienDir=1; marchNoteIdx=0; alienStepTimer=0; alienBulletTimer=0;
  const sy=68-Math.min((Math.max(wave,1)-1)*4,24);
  for(let row=0;row<5;row++) for(let col=0;col<11;col++){
    const type=row===0?'squid':row<=2?'crab':'octopus';
    const points=row===0?30:row<=2?20:10;
    aliens.push({type,points,x:24+col*16,y:sy+row*16,alive:true,col,row});
  }
  alienStepInterval=Math.max(80,800-(wave-1)*70);
}

function initGame(){
  score=0;lives=3;wave=1;
  player={x:104,y:232,alive:true};
  playerBullet=null;alienBullets=[];ufo=null;ufoTimer=3000;ufoShotCount=0;popups=[];
  initShields();initAliens();state=GS.PLAYING;targetIntensity=0.1;
}

function initTitle(){
  titleAliens=[];
  const types=['squid','crab','octopus'];
  for(let i=0;i<11;i++) titleAliens.push({type:types[i%3],x:-16+i*22,y:100+(i%3)*18,frame:0,speed:0.4+Math.random()*0.3});
}

// ============================================================
// TOUCH INPUT
// ============================================================
function setupTouch(el, key) {
  el.addEventListener('touchstart', e => { e.preventDefault(); keys[key]=true; el.classList.add('pressed'); if(!audioCtx) initAudio(); }, {passive:false});
  el.addEventListener('touchend',   e => { e.preventDefault(); keys[key]=false; el.classList.remove('pressed'); }, {passive:false});
  el.addEventListener('touchcancel',e => { keys[key]=false; el.classList.remove('pressed'); });
  // Also mouse for desktop testing
  el.addEventListener('mousedown', e => { keys[key]=true; el.classList.add('pressed'); if(!audioCtx) initAudio(); });
  el.addEventListener('mouseup',   e => { keys[key]=false; el.classList.remove('pressed'); });
}

setupTouch(document.getElementById('btnLeft'),  'ArrowLeft');
setupTouch(document.getElementById('btnRight'), 'ArrowRight');
setupTouch(document.getElementById('btnFire'),  'Fire');

document.getElementById('btnPause').addEventListener('touchstart', e => {
  e.preventDefault(); if(!audioCtx) initAudio();
  if(state===GS.PLAYING) state=GS.PAUSED;
  else if(state===GS.PAUSED) state=GS.PLAYING;
}, {passive:false});
document.getElementById('btnPause').addEventListener('mousedown', () => {
  if(!audioCtx) initAudio();
  if(state===GS.PLAYING) state=GS.PAUSED;
  else if(state===GS.PAUSED) state=GS.PLAYING;
});

// Tap canvas / anywhere to start
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  if(!audioCtx) initAudio();
  if(state===GS.TITLE) initGame();
  else if(state===GS.GAME_OVER){state=GS.TITLE;initTitle();}
}, {passive:false});
canvas.addEventListener('click', () => {
  if(!audioCtx) initAudio();
  if(state===GS.TITLE) initGame();
  else if(state===GS.GAME_OVER){state=GS.TITLE;initTitle();}
});

// Keyboard still works for desktop
document.addEventListener('keydown', e => {
  keys[e.code]=true; if(!audioCtx) initAudio();
  if(e.code==='KeyM'){musicEnabled=!musicEnabled;if(musicGain&&audioCtx)musicGain.gain.setTargetAtTime(musicEnabled?0.45:0,audioCtx.currentTime,0.3);}
  if(e.code==='KeyP'||e.code==='Escape'){if(state===GS.PLAYING)state=GS.PAUSED;else if(state===GS.PAUSED)state=GS.PLAYING;}
  if(e.code==='Enter'){if(state===GS.TITLE)initGame();else if(state===GS.GAME_OVER){state=GS.TITLE;initTitle();}}
  if(['ArrowLeft','ArrowRight','Space','KeyW'].includes(e.code)) e.preventDefault();
});
document.addEventListener('keyup', e => { keys[e.code]=false; });

// Music toggle button (long press fire = toggle music)
let fireLongPress = null;
document.getElementById('btnFire').addEventListener('touchstart', e => {
  fireLongPress = setTimeout(() => {
    musicEnabled=!musicEnabled;
    if(musicGain&&audioCtx) musicGain.gain.setTargetAtTime(musicEnabled?0.45:0,audioCtx.currentTime,0.3);
    const btn = document.getElementById('btnFire');
    btn.style.borderColor = musicEnabled ? '#AA2200' : '#444';
  }, 800);
}, {passive:true});
document.getElementById('btnFire').addEventListener('touchend', () => {
  if(fireLongPress){clearTimeout(fireLongPress);fireLongPress=null;}
});

// ============================================================
// UPDATE
// ============================================================
let lastFireState = false;

function update(dt){
  frameCount++;
  // Fire key — map touch 'Fire' to shoot action (fire on press, not hold)
  const fireNow = keys['Fire']||keys['Space']||keys['KeyZ']||keys['KeyW'];

  if(state===GS.TITLE){updateTitle(dt);return;}
  if(state===GS.PAUSED) return;
  if(state===GS.GAME_OVER) return;
  if(state===GS.WAVE_CLEAR){
    waveClearTimer-=dt;
    if(waveClearTimer<=0){wave++;initShields();initAliens();player.x=104;player.alive=true;playerBullet=null;alienBullets=[];state=GS.PLAYING;}
    return;
  }
  if(state===GS.DEAD){
    playerDeathTimer-=dt; playerDeathFrame=Math.floor((1500-playerDeathTimer)/200);
    if(playerDeathTimer<=0){if(lives<=0){state=GS.GAME_OVER;if(score>hiScore)hiScore=score;targetIntensity=0;}else{player.alive=true;playerBullet=null;state=GS.PLAYING;}}
    return;
  }
  // PLAYING
  updatePlayer(dt, fireNow);
  updatePlayerBullet();
  updateAliens(dt);
  updateAlienBullets(dt);
  updateUFO(dt);
  popups=popups.filter(p=>{p.timer--;p.y+=p.dy;return p.timer>0;});
  if(audioCtx) musicIntensity+=(targetIntensity-musicIntensity)*0.003;
  lastFireState=fireNow;
}

function updateTitle(dt){
  titleAnimTimer+=dt; titleAliens.forEach(a=>{a.x+=a.speed;if(a.x>W+16)a.x=-16;});
  if(titleAnimTimer>350){titleAnimTimer=0;titleAliens.forEach(a=>a.frame^=1);}
}

function updatePlayer(dt, fireNow){
  if(!player.alive) return;
  if((keys['ArrowLeft']||keys['KeyA'])&&player.x>8) player.x-=1.5;
  if((keys['ArrowRight']||keys['KeyD'])&&player.x<W-21) player.x+=1.5;
  // Fire on rising edge of touch (prevents holding to rapid fire)
  if(fireNow&&!lastFireState&&!playerBullet){
    playerBullet={x:player.x+6,y:player.y-2}; sfxShoot();
  }
}

function updatePlayerBullet(){
  if(!playerBullet) return;
  playerBullet.y-=4;
  if(playerBullet.y<8){playerBullet=null;return;}
  if(bulletHitsShield(playerBullet.x,playerBullet.y)){playerBullet=null;return;}
  if(ufo&&playerBullet.x>=ufo.x&&playerBullet.x<=ufo.x+14&&playerBullet.y>=ufo.y&&playerBullet.y<=ufo.y+7){
    const pts=UFO_POINTS[ufoShotCount++%4]; score+=pts; if(score>hiScore)hiScore=score;
    popups.push({x:ufo.x,y:ufo.y,text:String(pts),timer:60,dy:-0.12}); sfxUFOHit(); ufo=null; playerBullet=null; return;
  }
  for(const a of aliens){
    if(!a.alive) continue;
    const sw=a.type==='squid'?8:a.type==='crab'?11:12;
    if(playerBullet.x>=a.x&&playerBullet.x<=a.x+sw&&playerBullet.y>=a.y&&playerBullet.y<=a.y+8){
      a.alive=false; aliensKilled++; score+=a.points; if(score>hiScore)hiScore=score;
      popups.push({x:a.x,y:a.y,text:String(a.points),timer:45,dy:-0.12}); sfxAlienDie(); playerBullet=null;
      alienStepInterval=Math.max(80,800-(wave-1)*70-aliensKilled*12);
      targetIntensity=Math.min(1.0,0.1+(aliensKilled/55)*1.1);
      if(!aliens.filter(x=>x.alive).length){state=GS.WAVE_CLEAR;waveClearTimer=2500;targetIntensity=0.2;if(musicGain&&audioCtx)musicGain.gain.setTargetAtTime(0.15,audioCtx.currentTime,1.5);}
      return;
    }
  }
}

let alienMarchTimer=0;
function updateAliens(dt){
  alienMarchTimer+=dt; if(alienMarchTimer<alienStepInterval) return; alienMarchTimer-=alienStepInterval;
  sfxMarch(); alienAnimFrame^=1;
  const alive=aliens.filter(a=>a.alive); if(!alive.length) return;
  const minX=Math.min(...alive.map(a=>a.x));
  const maxX=Math.max(...alive.map(a=>a.x+(a.type==='octopus'?12:a.type==='crab'?11:8)));
  let drop=false;
  if(alienDir===1&&maxX>=W-6) drop=true; if(alienDir===-1&&minX<=6) drop=true;
  if(drop){
    alienDir*=-1; aliens.forEach(a=>{if(a.alive)a.y+=8;});
    if(Math.max(...aliens.filter(a=>a.alive).map(a=>a.y+8))>=player.y) killPlayer();
  } else aliens.forEach(a=>{if(a.alive)a.x+=alienDir*2;});
  alienBulletTimer+=alienStepInterval;
  const fi=Math.max(300,800-aliensKilled*10-(wave-1)*50);
  if(alienBulletTimer>=fi&&alienBullets.length<3){
    alienBulletTimer=0;
    const cols={}; alive.forEach(a=>{if(!cols[a.col]||a.y>cols[a.col].y)cols[a.col]=a;});
    const sh=Object.values(cols); if(sh.length){const s=sh[Math.floor(Math.random()*sh.length)];const sw=s.type==='squid'?8:s.type==='crab'?11:12;alienBullets.push({x:s.x+Math.floor(sw/2),y:s.y+9,frame:0,frameTimer:0});}
  }
}

function updateAlienBullets(dt){
  alienBullets=alienBullets.filter(b=>{
    b.y+=2; b.frameTimer+=dt; if(b.frameTimer>80){b.frame=(b.frame+1)%4;b.frameTimer=0;}
    if(bulletHitsShield(b.x,b.y)) return false;
    if(player.alive&&b.x>=player.x&&b.x<=player.x+12&&b.y>=player.y&&b.y<=player.y+8){killPlayer();return false;}
    return b.y<H;
  });
}

function killPlayer(){
  if(!player.alive) return;
  player.alive=false; lives--; playerBullet=null; playerDeathTimer=1500; playerDeathFrame=0;
  state=GS.DEAD; sfxPlayerDie(); sfxUFOStop(); targetIntensity=Math.max(0,targetIntensity-0.3);
}

function updateUFO(dt){
  ufoTimer-=dt;
  if(ufoTimer<=0&&!ufo){ufoTimer=25000+Math.random()*8000;const r=Math.random()<0.5;ufo={x:r?-16:W+4,y:28,dir:r?1:-1};sfxUFOStart();}
  if(ufo){ufo.x+=ufo.dir;if((ufo.dir===1&&ufo.x>W+20)||(ufo.dir===-1&&ufo.x<-20)){sfxUFOStop();ufo=null;}}
}

// ============================================================
// DRAW
// ============================================================
function draw(){
  const alive=aliens.filter(a=>a.alive);
  let bg='#000000';
  if(alive.length&&state===GS.PLAYING){const my=Math.max(...alive.map(a=>a.y+8));const d=Math.max(0,(my-140)/90);if(d>0)bg=`rgb(${Math.floor(d*12)},0,0)`;}
  ctx.fillStyle=bg; ctx.fillRect(0,0,W,H);

  if(state===GS.TITLE){drawTitle();scanlines();return;}

  drawHUD(); drawShields(); drawAliens(); drawPlayer(); drawBullets(); drawUFO(); drawPopups();

  if(state===GS.WAVE_CLEAR){
    drawText(ctx,'WAVE CLEAR',Math.floor((W-textWidth('WAVE CLEAR'))/2),118,'#FFFFFF');
    const wt='WAVE '+toRoman(wave); drawText(ctx,wt,Math.floor((W-textWidth(wt))/2),132,'#00FF41');
  }
  if(state===GS.GAME_OVER){
    ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(0,100,W,60);
    if(Math.floor(frameCount/20)%2) drawText(ctx,'GAME OVER',Math.floor((W-textWidth('GAME OVER'))/2),116,'#FF3300');
    drawText(ctx,'TAP TO CONTINUE',Math.floor((W-textWidth('TAP TO CONTINUE'))/2),134,'#FFFFFF');
  }
  if(state===GS.PAUSED){
    ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.fillRect(0,0,W,H);
    drawText(ctx,'PAUSED',Math.floor((W-textWidth('PAUSED'))/2),118,'#FFFF00');
    drawText(ctx,'TAP II TO RESUME',Math.floor((W-textWidth('TAP II TO RESUME'))/2),134,'#555555');
  }
  scanlines();
}

function drawTitle(){
  ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
  ctx.shadowColor='#00FF41'; ctx.shadowBlur=8*SCALE;
  drawText(ctx,'SPACE INVADERS',22,18,'#00FF41');
  ctx.shadowBlur=4*SCALE; drawText(ctx,'ACID MOBILE',34,31,'#00CC33');
  ctx.shadowBlur=0; ctx.shadowColor='transparent';
  drawText(ctx,'SCORE ADVANCE TABLE',14,52,'#FFFFFF');
  [{type:'squid',pts:'30 PTS',color:'#FFFFFF',y:68},{type:'crab',pts:'20 PTS',color:'#00FF41',y:86},{type:'octopus',pts:'10 PTS',color:'#AAFFAA',y:104}].forEach(t=>{
    drawSprite(ctx,SPRITES[t.type+'_a'],46,t.y,t.color); drawText(ctx,'= '+t.pts,72,t.y+1,'#FFFFFF');
  });
  drawSprite(ctx,SPRITES.ufo,43,122,'#FF2222'); drawText(ctx,'= ??? PTS',72,123,'#FF4444');
  titleAliens.forEach(a=>drawSprite(ctx,SPRITES[a.type+'_'+(a.frame?'b':'a')],a.x,a.y+42,'#1a3a1a'));
  if(Math.floor(frameCount/28)%2) drawText(ctx,'TAP TO PLAY',Math.floor((W-textWidth('TAP TO PLAY'))/2),172,'#FFFFFF');
  drawText(ctx,'HOLD FIRE = TOGGLE MUSIC',4,190,'#003300');
}

function drawHUD(){
  drawText(ctx,'SCORE<1>',6,4,'#FFFFFF'); drawText(ctx,'HI-SCORE',80,4,'#FFFFFF'); drawText(ctx,'SCORE<2>',154,4,'#FFFFFF');
  drawText(ctx,String(score).padStart(4,'0'),14,14,'#FFFFFF'); drawText(ctx,String(hiScore).padStart(4,'0'),88,14,'#FFFFFF'); drawText(ctx,'0000',162,14,'#FFFFFF');
  ctx.fillStyle='#00FF41'; ctx.fillRect(0,H-20,W,1);
  drawText(ctx,String(lives),8,H-14,'#FFFFFF');
  for(let i=0;i<Math.max(0,lives);i++) drawSprite(ctx,SPRITES.player,20+i*16,H-14,'#00FF41');
  drawText(ctx,'CREDIT  00',128,H-14,'#FFFFFF');
  const wt=toRoman(wave); drawText(ctx,wt,Math.floor(W/2-textWidth(wt)/2),H-14,'#004400');
}

function drawAliens(){
  aliens.forEach(a=>{
    if(!a.alive) return;
    const color=a.type==='squid'?'#FFFFFF':a.type==='crab'?'#00FF41':'#AAFFAA';
    drawSprite(ctx,SPRITES[a.type+'_'+(alienAnimFrame?'b':'a')],a.x,a.y,color);
  });
}

function drawPlayer(){
  if(state===GS.DEAD){
    for(let i=0;i<8;i++){ctx.fillStyle=`hsl(${20+Math.random()*30},100%,50%)`;ctx.fillRect(player.x+Math.random()*16-2,player.y+Math.random()*8,1+Math.random()*2,1);}
    drawSprite(ctx,SPRITES.explosion,player.x+3,player.y-1,'#FF4400'); return;
  }
  if(!player.alive) return;
  drawSprite(ctx,SPRITES.player,player.x,player.y,'#00FF41');
}

function drawBullets(){
  if(playerBullet){ctx.fillStyle='#FFFFFF';ctx.fillRect(Math.floor(playerBullet.x),Math.floor(playerBullet.y),1,4);}
  const offsets=[0,1,0,-1];
  alienBullets.forEach(b=>{ctx.fillStyle='#FF4400';for(let i=0;i<5;i++)ctx.fillRect(Math.floor(b.x)+offsets[(i+b.frame)%4],Math.floor(b.y)+i,1,1);});
}

function drawUFO(){
  if(!ufo) return;
  ctx.shadowColor='#FF0000'; ctx.shadowBlur=3*SCALE;
  drawSprite(ctx,SPRITES.ufo,ufo.x,ufo.y,'#FF2222');
  ctx.shadowBlur=0; ctx.shadowColor='transparent';
}

function drawPopups(){
  popups.forEach(p=>{ctx.globalAlpha=Math.min(1,p.timer/30);drawText(ctx,p.text,Math.floor(p.x),Math.floor(p.y),'#FFFF00');ctx.globalAlpha=1;});
}

function scanlines(){
  octx.clearRect(0,0,canvas.width,canvas.height);
  octx.fillStyle='rgba(0,0,0,0.07)';
  for(let y=0;y<canvas.height;y+=2) octx.fillRect(0,y,canvas.width,1);
}

function toRoman(n){
  const v=[1000,900,500,400,100,90,50,40,10,9,5,4,1],s=['M','CM','D','CD','C','XC','L','XL','X','IX','V','IV','I'];
  let r=''; v.forEach((val,i)=>{while(n>=val){r+=s[i];n-=val;}}); return r;
}

// ============================================================
// LOOP
// ============================================================
let lastTime=0;
function gameLoop(ts){
  const dt=Math.min(50,ts-lastTime); lastTime=ts;
  update(dt); draw();
  requestAnimationFrame(gameLoop);
}

initTitle();
requestAnimationFrame(t=>{lastTime=t;requestAnimationFrame(gameLoop);});
</script>
</body>
</html>
